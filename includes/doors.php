<?php 
$trame_num = 0 ; 
function get_licences($data)
{
    $licence =  str_replace('telelogic','',$data);

    $licence = bin2hex($licence) ; 

    $licences = explode('7e000000000000000000',$licence);

    $lcs = array();
    foreach ($licences as $l)
    {
        $l = substr($l,strpos($l,'7e0000000000000000')+strlen('7e0000000000000000')) ; 
        $l = substr($l,0,strpos($l,'00504')) ; 
        $l = hex2bin($l) ; 
        if (strlen($l) != 0) $lcs[]=$l ;
    }
    return $lcs ; 
}

// tentative de récupération des infos doors :
echo "Initiate doors connexion ... \n";
$sckt = socket_create(AF_INET, SOCK_STREAM,getprotobyname('tcp')) ;
$doors = socket_connect($sckt,gethostbyname("fr-bor-eea"), 27000);
try {

    $data = "\x68\x51\x31\x33\x44\x55\x4d\x41\x53\x4e\x00\x00\x00\x00\x00\x00".
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x50\x43\x2d\x54\x4e\x53\x33".
    "\x30\x32\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00".
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00".
    "\x00\x00\x00\x00\x00\x50\x43\x2d\x54\x4e\x53\x33\x30\x32\x00\x00".
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00".
    "\x00\x00\x00\x00\x00\x00\x54\x00\x00\x00\x00\x00\x00\x00\x00\x00".
    "\x00\x00\x00\x35\x31\x34\x39\x32\x00\x00\x00\x00\x00\x00\x78\x36".
    "\x34\x5f\x6e\x36\x00\x00\x00\x00\x00\x00\x00\x0b\x0c\x37\x38\x00".
    "\x31\x34\x00" ; 

    socket_write($sckt,$data,strlen($data)) ; 
    $fg = socket_read($sckt, 2048);

//---------------------------------------------------------------------------------------


    $data = "\x68\x51\x31\x33\x44\x55\x4d\x41\x53\x4e\x00\x00\x00\x00\x00\x00" .
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x50\x43\x2d\x54\x4e\x53\x33" .
    "\x30\x32\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" .
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" .
    "\x00\x00\x00\x00\x00\x50\x43\x2d\x54\x4e\x53\x33\x30\x32\x00\x00" .
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" .
    "\x00\x00\x00\x00\x00\x00\x54\x00\x00\x00\x00\x00\x00\x00\x00\x00" .
    "\x00\x00\x00\x35\x31\x34\x39\x32\x00\x00\x00\x00\x00\x00\x78\x36" .
    "\x34\x5f\x6e\x36\x00\x00\x00\x00\x00\x00\x00\x0b\x0c\x37\x38\x00" .
    "\x31\x34\x00" ;


    socket_write($sckt,$data,strlen($data)) ; 
    $fg = socket_read($sckt, 2048);

//---------------------------------------------------------------------------------------



    $data = "\x2f\xcb\x10\x71\x00\x40\x01\x08\x5d\xf2\x11\x72\x00\x00\x00\x00" .
    "\x00\x00\x00\x00\x01\x04\x44\x55\x4d\x41\x53\x4e\x00\x50\x43\x2d" .
    "\x54\x4e\x53\x33\x30\x32\x00\x6c\x6d\x67\x72\x64\x00\x50\x43\x2d" .
    "\x54\x4e\x53\x33\x30\x32\x00\x67\x65\x74\x70\x61\x74\x68\x73\x00" ;
    
    socket_write($sckt,$data,strlen($data)) ; 
    $fg = socket_read($sckt, 2048);


//---------------------------------------------------------------------------------------

    $data = "\x68\x51\x31\x33\x44\x55\x4d\x41\x53\x4e\x00\x00\x00\x00\x00\x00" .
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x50\x43\x2d\x54\x4e\x53\x33" .
    "\x30\x32\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" .
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" .
    "\x00\x00\x00\x00\x00\x50\x43\x2d\x54\x4e\x53\x33\x30\x32\x00\x00" .
    "\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" .
    "\x00\x00\x00\x00\x00\x00\x54\x00\x00\x00\x00\x00\x00\x00\x00\x00" .
    "\x00\x00\x00\x35\x31\x34\x39\x32\x00\x00\x00\x00\x00\x00\x78\x36" .
    "\x34\x5f\x6e\x36\x00\x00\x00\x00\x00\x00\x00\x0b\x0c\x37\x38\x00" .
    "\x31\x34\x00" ; 

    socket_write($sckt,$data,strlen($data)) ; 
    $fg = socket_read($sckt, 2048);


    //---------------------------------------------------------------------------------------

    $data = "\x2f\x3e\x0b\xeb\x00\x3d\x01\x08\x5d\xf2\x11\x73\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x01\x04\x44\x55\x4d\x41\x53\x4e\x00\x50\x43\x2d" .
"\x54\x4e\x53\x33\x30\x32\x00\x6c\x6d\x67\x72\x64\x00\x50\x43\x2d" .
"\x54\x4e\x53\x33\x30\x32\x00\x64\x6c\x69\x73\x74\x00"; 

socket_write($sckt,$data,strlen($data)) ; 
$fg = socket_read($sckt, 2048);

echo "... licence ... \n";

//---------------------------------------------------------------------------------------

$data = "\x68\x51\x31\x33\x44\x55\x4d\x41\x53\x4e\x00\x00\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x50\x43\x2d\x54\x4e\x53\x33" .
"\x30\x32\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x00\x50\x43\x2d\x54\x4e\x53\x33\x30\x32\x00\x00" .
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x00\x00\x54\x00\x00\x00\x00\x00\x00\x00\x00\x00" .
"\x00\x00\x00\x35\x31\x34\x39\x32\x00\x00\x00\x00\x00\x00\x78\x36" .
"\x34\x5f\x6e\x36\x00\x00\x00\x00\x00\x00\x00\x0b\x0c\x37\x38\x00" .
"\x31\x34\x00"; 

socket_write($sckt,$data,strlen($data)) ; 
$fg = socket_read($sckt, 2048);



//---------------------------------------------------------------------------------------

$data = "\x2f\x79\x1e\x17\x00\x38\x01\x08\x5d\xf2\x11\x74\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x01\x04\x44\x55\x4d\x41\x53\x4e\x00\x50\x43\x2d" .
"\x54\x4e\x53\x33\x30\x32\x00\x6c\x6d\x67\x72\x64\x00\x50\x43\x2d" .
"\x54\x4e\x53\x33\x30\x32\x00\x00"; 

socket_write($sckt,$data,strlen($data)) ; 
$fg = socket_read($sckt, 4000);


//---------------------------------------------------------------------------------------


$data = "\x68\x51\x31\x33\x44\x55\x4d\x41\x53\x4e\x00\x00\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x50\x43\x2d\x54\x4e\x53\x33" .
"\x30\x32\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x00\x50\x43\x2d\x54\x4e\x53\x33\x30\x32\x00\x00" .
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x00\x00\x54\x00\x00\x00\x00\x00\x00\x00\x00\x00" .
"\x00\x00\x00\x35\x31\x34\x39\x32\x00\x00\x00\x00\x00\x00\x78\x36" .
"\x34\x5f\x6e\x36\x00\x00\x00\x00\x00\x00\x00\x0b\x0c\x37\x38\x00" .
"\x31\x34\x00"; 

socket_write($sckt,$data,strlen($data)) ; 
$fg = socket_read($sckt, 2048);



//---------------------------------------------------------------------------------------


$data = "\x68\x3c\x31\x33\x44\x55\x4d\x41\x53\x4e\x00\x00\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x50\x43\x2d\x54\x4e\x53\x33" .
"\x30\x32\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x69\x62\x6d\x72\x61\x74" .
"\x6c\x00\x00\x00\x00\x50\x43\x2d\x54\x4e\x53\x33\x30\x32\x00\x00" .
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x00\x00\x54\x00\x00\x00\x00\x00\x00\x00\x00\x00" .
"\x00\x00\x00\x35\x31\x34\x39\x32\x00\x00\x00\x00\x00\x00\x78\x36" .
"\x34\x5f\x6e\x36\x00\x00\x00\x00\x00\x00\x00\x0b\x0c\x37\x38\x00" .
"\x31\x34\x00"; 

socket_write($sckt,$data,strlen($data)) ; 
$fg = socket_read($sckt, 4000);

echo "Connexion success ! ... \n";

//---------------------------------------------------------------------------------------

$port = substr(bin2hex ($fg),-18,4);
$sckt2 = socket_create(AF_INET, SOCK_STREAM,getprotobyname('tcp')) ;
socket_connect($sckt2,gethostbyname("fr-bor-eea"), intval($port,16));


//---------------------------------------------------------------------------------------


$data = "\x68\x3c\x31\x33\x44\x55\x4d\x41\x53\x4e\x00\x00\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x50\x43\x2d\x54\x4e\x53\x33" .
"\x30\x32\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x69\x62\x6d\x72\x61\x74" .
"\x6c\x00\x00\x00\x00\x50\x43\x2d\x54\x4e\x53\x33\x30\x32\x00\x00" .
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x00\x00\x54\x00\x00\x00\x00\x00\x00\x00\x00\x00" .
"\x00\x00\x00\x35\x31\x34\x39\x32\x00\x00\x00\x00\x00\x00\x78\x36" .
"\x34\x5f\x6e\x36\x00\x00\x00\x00\x00\x00\x00\x0b\x0c\x37\x38\x00" .
"\x31\x34\x00" ; 
socket_write($sckt2,$data,strlen($data)) ; 
$fg = socket_read($sckt2, 2048);



//---------------------------------------------------------------------------------------


$data = "\x2f\x06\x05\xa9\x00\x18\x01\x3b\x5d\xf2\x11\x75\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x31\x00\x30\x00";


socket_write($sckt2,$data,strlen($data)) ; 
$fg = socket_read($sckt2, 2048);



//---------------------------------------------------------------------------------------


$data = "\x2f\xad\x15\x52\x00\x19\x01\x27\x5d\xf2\x11\x76\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x01\x00\x00\x00\x00" ; 


socket_write($sckt2,$data,strlen($data)) ; 
$fg = socket_read($sckt2, 2048);



//---------------------------------------------------------------------------------------


$data = "\x68\x09\x31\x33\x44\x55\x4d\x41\x53\x4e\x00\x00\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x50\x43\x2d\x54\x4e\x53\x33" .
"\x30\x32\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x74\x65\x6c\x65\x6c\x6f" .
"\x67\x69\x63\x00\x00\x50\x43\x2d\x54\x4e\x53\x33\x30\x32\x00\x00" .
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x00\x00\x54\x00\x00\x00\x00\x00\x00\x00\x00\x00" .
"\x00\x00\x00\x35\x31\x34\x39\x32\x00\x00\x00\x00\x00\x00\x78\x36" .
"\x34\x5f\x6e\x36\x00\x00\x00\x00\x00\x00\x00\x0b\x0c\x37\x38\x00" .
"\x31\x34\x00" ;


socket_write($sckt,$data,strlen($data)) ; 
$fg = socket_read($sckt, 2048);

echo "Get licence infos ... \n";

//---------------------------------------------------------------------------------------
//---------------------------------------------------------------------------------------

$port = substr(bin2hex ($fg),-18,4);
$sckt3 = socket_create(AF_INET, SOCK_STREAM,getprotobyname('tcp')) ;
socket_connect($sckt3,gethostbyname("fr-bor-eea"), intval($port,16));


//---------------------------------------------------------------------------------------

$data = "\x68\x09\x31\x33\x44\x55\x4d\x41\x53\x4e\x00\x00\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x50\x43\x2d\x54\x4e\x53\x33" .
"\x30\x32\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x74\x65\x6c\x65\x6c\x6f" .
"\x67\x69\x63\x00\x00\x50\x43\x2d\x54\x4e\x53\x33\x30\x32\x00\x00" .
"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x00\x00\x54\x00\x00\x00\x00\x00\x00\x00\x00\x00" .
"\x00\x00\x00\x35\x31\x34\x39\x32\x00\x00\x00\x00\x00\x00\x78\x36" .
"\x34\x5f\x6e\x36\x00\x00\x00\x00\x00\x00\x00\x0b\x0c\x37\x38\x00" .
"\x31\x34\x00";

socket_write($sckt3,$data,strlen($data)) ; 
$fg = socket_read($sckt3, 2048);

//---------------------------------------------------------------------------------------

$data = "\x2f\x93\x1d\x1c\x00\x18\x01\x3b\x5d\xf2\x11\x77\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x31\x00\x30\x00";

socket_write($sckt3,$data,strlen($data)) ; 
$fg = socket_read($sckt3, 2048);



//---------------------------------------------------------------------------------------

$data = "\x2f\x80\x12\x26\x00\x19\x01\x27\x5d\xf2\x11\x78\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x01\x00\x00\x00\x00";

socket_write($sckt3,$data,strlen($data)) ; 
$fg = socket_read($sckt3, 2048);



//---------------------------------------------------------------------------------------

$data = "\x2f\x89\x19\xf9\x00\x32\x01\x3c\x5d\xf2\x11\x79\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x44\x43\x43\x43\x00\x36\x30\x41\x30\x45\x30\x38" .
"\x30\x41\x44\x35\x46\x32\x38\x39\x35\x44\x34\x38\x37\x00\x00\x00" .
"\x00\x01" ;


socket_write($sckt3,$data,strlen($data)) ; 
$fg = socket_read($sckt3, 2048);



//---------------------------------------------------------------------------------------


$data = "\x2f\x70\x17\xe1\x00\x32\x01\x3c\x5d\xf2\x11\x7a\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x44\x43\x43\x43\x00\x39\x30\x46\x30\x46\x30\x36" .
"\x30\x32\x37\x43\x35\x39\x41\x45\x38\x31\x45\x30\x35\x00\x00\x00" .
"\x00\x01" ;


socket_write($sckt3,$data,strlen($data)) ; 
$fg = socket_read($sckt3, 2048);



//---------------------------------------------------------------------------------------


$data = "\x2f\xe6\x16\x57\x00\x32\x01\x3c\x5d\xf2\x11\x7b\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x44\x43\x43\x51\x00\x36\x30\x34\x30\x46\x30\x34" .
"\x30\x35\x33\x39\x39\x35\x34\x44\x46\x37\x34\x45\x33\x00\x00\x00" .
"\x00\x01";


socket_write($sckt3,$data,strlen($data)) ; 
$fg = socket_read($sckt3, 2048);



//---------------------------------------------------------------------------------------


$data ="\x2f\x3f\x11\xb4\x00\x32\x01\x3c\x5d\xf2\x11\x7c\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x44\x43\x43\x51\x00\x44\x30\x39\x30\x37\x30\x41" .
"\x30\x38\x39\x38\x46\x39\x36\x32\x36\x45\x36\x42\x31\x00\x00\x00" .
"\x00\x01";


socket_write($sckt3,$data,strlen($data)) ; 
$fg = socket_read($sckt3, 2048);



//---------------------------------------------------------------------------------------


$data = "\x2f\x5e\x1c\xc6\x00\x33\x01\x3c\x5d\xf2\x11\x7d\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x44\x4f\x4f\x52\x53\x00\x38\x30\x42\x30\x45\x30" .
"\x35\x30\x39\x43\x36\x34\x34\x46\x37\x38\x41\x31\x33\x32\x00\x00" .
"\x00\x00\x01" ;


socket_write($sckt3,$data,strlen($data)) ; 
$fg = socket_read($sckt3, 2048);



//---------------------------------------------------------------------------------------

// we are connected and identified to DOORS database, send licence get request : 

//---------------------------------------------------------------------------------------


$data = "\x2f\xed\x2c\x44\x00\x33\x01\x3c\x5d\xf2\x11\x7e\x00\x00\x00\x00" .
"\x00\x00\x00\x00\x44\x4f\x4f\x52\x53\x00\x31\x30\x36\x30\x45\x30" .
"\x30\x30\x43\x46\x42\x46\x41\x43\x34\x34\x42\x38\x30\x32\x00\x00" .
"\x00\x00\x01" ;

socket_write($sckt3,$data,strlen($data)) ; 

// header contains number of all licence, and number of used licence

$fg = socket_read($sckt3, 1460);
echo "licence (0) ... ";

$fg = bin2hex($fg) ; 
$fg = substr($fg,strpos($fg,'7e00000000000000004e')+strlen('7e00000000000000004e')+2) ;
$nb_lic = substr($fg,0,strpos($fg,'00'));
if (strlen($nb_lic) == 1 or strlen($nb_lic) == 3) $nb_lic .= '0' ; 
$nb_lic = intval(hex2bin($nb_lic)) ; 
$nb_tt = substr($fg,6,strpos($fg,'313537')-6);
$nb_tt = intval(trim(hex2bin($nb_tt))) ; 

echo "return : $nb_lic (used) / $nb_tt (total) \n" ; 

// while not received all licence information, get data : 

$lcs = array() ; 
$licence = '' ; 
$i = 0 ; 

while ($nb_lic > count($lcs) )
{
$licence1 = socket_read($sckt3, 1500);
$licence .= $licence1 ;
$i++ ; 
echo "licence ($i) ... ";
$lcs = get_licences($licence) ;
echo "return : ". count($lcs)." (info) / $nb_lic (used) \n" ; 
}

// format licence data : 

$txt = time() .';'. $nb_lic . ';' . $nb_tt ; 

foreach ($lcs as $l)
{
    $txt .= ';'.$l ; 
}

$txt .= ";\n";

file_put_contents('/var/www/html/ram/doors_licences.txt',$txt,FILE_APPEND);

echo $txt ; 

$_DOORS = $lcs ; 
$_DOORS_NB = $nb_lic ; 
$_DOORS_TT = $nb_tt ; 

}
finally  {}

socket_close ($sckt);

socket_close ($sckt2);

socket_close ($sckt3);
